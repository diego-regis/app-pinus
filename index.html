<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PinusSniper V6</title>
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üå≤</text></svg>">

    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <style>
        body { margin: 0; background: #000; color: white; font-family: sans-serif; overflow: hidden; user-select: none; }
        
        /* Viewport Principal */
        #viewport { position: relative; width: 100vw; height: 100vh; overflow: hidden; background: #000; }
        #image-layer { transform-origin: 0 0; will-change: transform; }
        
        /* Mira */
        #crosshair-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: flex; justify-content: center; align-items: center; z-index: 10;
        }
        .crosshair {
            width: 50px; height: 50px;
            border: 2px solid #00ff00; border-radius: 5px; position: relative;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
        }
        .crosshair::after {
            content: ''; position: absolute; top: 50%; left: 50%; width: 4px; height: 4px;
            background: red; transform: translate(-50%, -50%); border-radius: 50%;
        }

        /* Marcadores */
        .marker {
            position: absolute; width: 24px; height: 24px; 
            transform: translate(-50%, -50%);
            border: 2px solid white; border-radius: 50%;
            z-index: 5; background: rgba(0,0,0,0.4);
            font-size: 14px; display: flex; justify-content: center; align-items: center; color: white; font-weight: bold;
        }

        /* UI Inferior */
        #ui-layer {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: rgba(15, 15, 15, 0.95); padding: 15px; box-sizing: border-box;
            border-top: 1px solid #333; z-index: 20; padding-bottom: 25px;
            display: flex; flex-direction: column; gap: 10px;
        }

        .top-info {
            position: absolute; top: 0; left: 0; width: 100%;
            padding: 15px; background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent);
            text-align: center; z-index: 20; pointer-events: none;
        }

        /* Bot√µes */
        button {
            padding: 16px; border: none; border-radius: 8px;
            font-weight: bold; font-size: 1.1rem; text-transform: uppercase; cursor: pointer;
            width: 100%; outline: none; box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
        button:active { transform: scale(0.97); }
        
        .btn-camera { background: #FF9800; color: white; }
        .btn-mark { background: #D32F2F; color: white; font-size: 1.3rem; border: 2px solid white; height: 75px; }
        .btn-save-h { background: #2E7D32; color: white; }
        .btn-save-l { background: #1976D2; color: white; }
        .btn-list { background: #444; color: white; font-size: 0.9rem; padding: 12px; }
        .btn-undo { background: #555; color: white; width: 70px; }

        .row { display: flex; gap: 10px; }
        input { padding: 10px; width: 80px; text-align: center; border-radius: 5px; border: none; background: #333; color: white; font-size: 1.1rem; }

        /* Modal de Hist√≥rico */
        #history-modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #111; z-index: 100; display: none; flex-direction: column;
        }
        #history-header {
            padding: 20px; background: #222; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #444;
        }
        #history-content {
            flex-grow: 1; overflow-y: auto; padding: 10px;
        }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { text-align: left; color: #888; padding: 10px 5px; border-bottom: 1px solid #444; }
        td { padding: 12px 5px; border-bottom: 1px solid #333; color: #ddd; }
        .val-col { color: #00ff00; font-weight: bold; }
        .del-btn { background: #D32F2F; padding: 5px 10px; font-size: 0.8rem; border-radius: 4px; width: auto; }

        /* Toast */
        #toast {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9); color: #00ff00; padding: 20px 40px; border-radius: 15px;
            font-size: 1.5rem; display: none; z-index: 150; border: 2px solid #00ff00;
        }
    </style>
</head>
<body>

    <div id="toast">‚úÖ SALVO!</div>

    <div id="viewport">
        <div id="image-layer">
            <img id="photo-display" style="display:none;">
            <div id="markers-container"></div>
            <video id="video-feed" autoplay playsinline style="width: 100%; height: 100%; object-fit: contain;"></video>
        </div>
        
        <div id="crosshair-layer" style="display:none;"><div class="crosshair"></div></div>

        <div class="top-info">
            <span id="status-text" style="font-size: 1.2rem; font-weight: bold; color: #fff;">üì∑ Modo C√¢mera</span>
            <div id="instruction-text" style="font-size: 0.9rem; color: #ccc;">Aponte para a pilha</div>
        </div>

        <div id="ui-layer">
            <div class="row" style="justify-content: space-between; align-items: center; margin-bottom: 5px;">
                <div>Baliza: <input type="number" id="ref-size" value="2.00" step="0.1"> m</div>
                <div id="measure-result" style="font-size: 1.3rem; color: #00ff00; font-weight: bold;">0.00 m</div>
            </div>

            <div id="btn-container">
                <button class="btn-camera" onclick="takePhoto()">üì∏ Capturar</button>
            </div>

            <div id="edit-controls" class="row" style="display:none;">
                <button class="btn-undo" onclick="undoPoint()">‚Ü©</button>
                <button class="btn-mark" onclick="markPoint()">üéØ MARCAR</button>
            </div>

            <div id="save-controls" class="row" style="display:none;">
                <button class="btn-save-h" onclick="saveSafe('Altura')">Salvar ALTURA</button>
                <button class="btn-save-l" onclick="saveSafe('Comprimento')">Salvar COMP.</button>
            </div>
            
            <div id="retry-btn" style="display:none; margin-top:5px;">
                <button style="background:#444; padding: 12px; font-size: 0.9rem;" onclick="resetApp()">üóëÔ∏è Descartar</button>
            </div>

            <div class="row" style="margin-top: 10px;">
                <button class="btn-list" onclick="toggleHistory()">üìú Ver Lista (<span id="data-count">0</span>)</button>
                <button class="btn-list" style="background: #1976D2;" onclick="exportExcel()">üìÇ Excel</button>
            </div>
        </div>
    </div>

    <div id="history-modal">
        <div id="history-header">
            <h3 style="margin:0;">Hist√≥rico de Medi√ß√µes</h3>
            <button style="width: auto; padding: 10px 20px; background: #555;" onclick="toggleHistory()">Fechar X</button>
        </div>
        <div id="history-content">
            <table id="history-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Tipo</th>
                        <th>Valor</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="history-body">
                    </tbody>
            </table>
            <button onclick="clearAllData()" style="background: #D32F2F; margin-top: 20px;">üóëÔ∏è Apagar Tudo</button>
        </div>
    </div>

    <script>
        // --- Setup ---
        const video = document.getElementById('video-feed');
        const imgDisplay = document.getElementById('photo-display');
        const imgLayer = document.getElementById('image-layer');
        const crosshair = document.getElementById('crosshair-layer');
        const markersContainer = document.getElementById('markers-container');
        const historyModal = document.getElementById('history-modal');
        const historyBody = document.getElementById('history-body');
        
        // UI Text
        const statusText = document.getElementById('status-text');
        const instrText = document.getElementById('instruction-text');
        const resultDisp = document.getElementById('measure-result');
        const toast = document.getElementById('toast');

        // UI Groups
        const btnContainer = document.getElementById('btn-container');
        const editControls = document.getElementById('edit-controls');
        const saveControls = document.getElementById('save-controls');
        const retryBtn = document.getElementById('retry-btn');

        // Logic Vars
        let state = 'CAMERA'; 
        let points = [];
        let pxPerMeter = 1;
        let transform = { x: 0, y: 0, scale: 1 };
        let lastTouch = { x: 0, y: 0, dist: 0 };
        let isDragging = false;
        
        // Carrega dados
        let dataStore = [];
        try { dataStore = JSON.parse(localStorage.getItem('pinusDataV6')) || []; } catch(e) {}
        updateCount();

        // --- Camera ---
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment', width: { ideal: 4096 } } 
                });
                video.srcObject = stream;
                await video.play();
            } catch(e) { console.log("Cam Error", e); }
        }
        startCamera();

        // --- A√ß√µes ---
        function takePhoto() {
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);
            
            imgDisplay.src = canvas.toDataURL('image/jpeg');
            imgDisplay.style.display = 'block';
            video.style.display = 'none';
            
            state = 'MARKING';
            resetUIForMarking();
        }

        function markPoint() {
            const viewportW = window.innerWidth;
            const viewportH = window.innerHeight;
            const imgX = ((viewportW / 2) - transform.x) / transform.scale;
            const imgY = ((viewportH / 2) - transform.y) / transform.scale;

            points.push({ x: imgX, y: imgY });
            
            const m = document.createElement('div');
            m.className = 'marker';
            m.style.left = imgX + 'px';
            m.style.top = imgY + 'px';
            m.innerText = points.length;
            m.style.borderColor = (points.length <= 2) ? '#ff4444' : '#00ff00';
            markersContainer.appendChild(m);

            checkProgress();
        }

        function undoPoint() {
            if(points.length === 0) return resetApp();
            points.pop();
            if(markersContainer.lastChild) markersContainer.lastChild.remove();
            checkProgress();
        }

        function checkProgress() {
            const len = points.length;
            if (len === 0) updateInfo("Marque BALIZA 1", "Zoom com 2 dedos");
            else if (len === 1) updateInfo("Marque BALIZA 2", "Zoom com 2 dedos");
            else if (len === 2) {
                const dist = Math.hypot(points[1].x - points[0].x, points[1].y - points[0].y);
                const refVal = parseFloat(document.getElementById('ref-size').value);
                pxPerMeter = dist / refVal;
                updateInfo("Marque IN√çCIO Pilha", "Refer√™ncia OK");
            }
            else if (len === 3) updateInfo("Marque FIM Pilha", "√öltimo ponto");
            else if (len === 4) {
                const dist = Math.hypot(points[3].x - points[2].x, points[3].y - points[2].y);
                const finalVal = dist / pxPerMeter;
                resultDisp.innerText = finalVal.toFixed(2) + " m";
                state = 'SAVING';
                crosshair.style.display = 'none';
                editControls.style.display = 'none';
                saveControls.style.display = 'flex';
                retryBtn.style.display = 'block';
                updateInfo("Pronto!", "Salve Altura ou Comprimento");
            }
        }

        // --- Gest√£o de Dados (Nova Fun√ß√£o V6) ---
        function saveSafe(tipo) {
            try {
                const val = resultDisp.innerText;
                const ref = document.getElementById('ref-size').value;
                
                dataStore.push({
                    id: Date.now(), // ID √∫nico
                    time: new Date().toLocaleTimeString(),
                    tipo: tipo,
                    valor: val,
                    ref: ref
                });
                
                localStorage.setItem('pinusDataV6', JSON.stringify(dataStore));
                updateCount();
                
                toast.style.display = 'block';
                setTimeout(() => { toast.style.display = 'none'; resetApp(); }, 1000);
            } catch(e) { alert("Erro salvar"); resetApp(); }
        }

        function toggleHistory() {
            if (historyModal.style.display === 'flex') {
                historyModal.style.display = 'none';
            } else {
                renderHistoryTable();
                historyModal.style.display = 'flex';
            }
        }

        function renderHistoryTable() {
            historyBody.innerHTML = "";
            // Mostra do mais recente para o mais antigo
            dataStore.slice().reverse().forEach((item, index) => {
                // O √≠ndice real no array original √©: dataStore.length - 1 - index
                const realIndex = dataStore.length - 1 - index;
                
                const row = `
                    <tr>
                        <td>#${dataStore.length - index}<br><small>${item.time}</small></td>
                        <td>${item.tipo === 'Altura' ? '‚ÜïÔ∏è Alt' : '‚ÜîÔ∏è Comp'}</td>
                        <td class="val-col">${item.valor}</td>
                        <td><button class="del-btn" onclick="deleteItem(${realIndex})">X</button></td>
                    </tr>
                `;
                historyBody.innerHTML += row;
            });
        }

        function deleteItem(index) {
            if(confirm("Apagar este item?")) {
                dataStore.splice(index, 1);
                localStorage.setItem('pinusDataV6', JSON.stringify(dataStore));
                updateCount();
                renderHistoryTable(); // Atualiza a tabela aberta
            }
        }

        function clearAllData() {
            if(confirm("ATEN√á√ÉO: Isso apagar√° TUDO. Continuar?")) {
                dataStore = [];
                localStorage.setItem('pinusDataV6', JSON.stringify(dataStore));
                updateCount();
                renderHistoryTable();
            }
        }

        function updateCount() {
            document.getElementById('data-count').innerText = dataStore.length;
        }

        // --- Core ---
        function resetApp() {
            state = 'CAMERA';
            points = [];
            transform = { x: 0, y: 0, scale: 1 };
            markersContainer.innerHTML = '';
            imgDisplay.style.display = 'none';
            resultDisp.innerText = "0.00 m";
            btnContainer.style.display = 'block';
            editControls.style.display = 'none';
            saveControls.style.display = 'none';
            crosshair.style.display = 'none';
            retryBtn.style.display = 'none';
            updateInfo("üì∑ Modo C√¢mera", "Aponte para a pilha");
            updateTransform();
            video.style.display = 'block';
            video.play().catch(e=>{});
        }

        function updateInfo(main, sub) {
            statusText.innerText = main;
            instrText.innerText = sub;
        }

        function resetUIForMarking() {
            btnContainer.style.display = 'none';
            editControls.style.display = 'flex';
            crosshair.style.display = 'flex';
            updateInfo("Marque BALIZA 1", "Use zoom (2 dedos)");
        }

        // --- Zoom ---
        const view = document.getElementById('viewport');
        view.addEventListener('touchstart', e => {
            if(state !== 'MARKING') return;
            isDragging = true;
            if(e.touches.length === 2) lastTouch.dist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
            else { lastTouch.x = e.touches[0].clientX; lastTouch.y = e.touches[0].clientY; }
        });
        view.addEventListener('touchmove', e => {
            if(state !== 'MARKING' || !isDragging) return;
            e.preventDefault();
            if(e.touches.length === 2) {
                const newDist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
                transform.scale = Math.max(0.5, Math.min(transform.scale * (newDist / lastTouch.dist), 8));
                lastTouch.dist = newDist;
            } else {
                transform.x += e.touches[0].clientX - lastTouch.x;
                transform.y += e.touches[0].clientY - lastTouch.y;
                lastTouch.x = e.touches[0].clientX;
                lastTouch.y = e.touches[0].clientY;
            }
            updateTransform();
        });
        view.addEventListener('touchend', () => isDragging = false);
        function updateTransform() { imgLayer.style.transform = `translate(${transform.x}px, ${transform.y}px) scale(${transform.scale})`; }

        function exportExcel() {
            if(dataStore.length === 0) return alert("Sem dados!");
            const ws = XLSX.utils.json_to_sheet(dataStore);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Levantamento");
            XLSX.writeFile(wb, "Levantamento_V6.xlsx");
        }
    </script>
</body>
</html>