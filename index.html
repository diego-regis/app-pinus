<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PinusSniper V9 (Fix)</title>
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üå≤</text></svg>">

    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <style>
        body { margin: 0; background: #000; color: white; font-family: sans-serif; overflow: hidden; user-select: none; }
        
        #viewport { position: relative; width: 100vw; height: 100vh; overflow: hidden; background: #000; }
        #image-layer { transform-origin: 0 0; will-change: transform; width: 100%; height: 100%; }
        
        /* C√¢mera e Foto */
        video { width: 100%; height: 100%; object-fit: contain; display: block; }
        img { width: 100%; height: 100%; object-fit: contain; display: none; }

        /* Mira */
        #crosshair-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: flex; justify-content: center; align-items: center; z-index: 10;
        }
        .crosshair {
            width: 50px; height: 50px;
            border: 2px solid #00ff00; border-radius: 5px; position: relative;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
        }
        .crosshair::after {
            content: ''; position: absolute; top: 50%; left: 50%; width: 4px; height: 4px;
            background: red; transform: translate(-50%, -50%); border-radius: 50%;
        }

        /* Grade FE */
        #grid-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; justify-content: center; align-items: center; z-index: 15; pointer-events: none;
        }
        .grid-box {
            width: 80vw; height: 80vw; max-width: 350px; max-height: 350px;
            border: 2px dashed #FFD700;
            display: grid; grid-template-columns: repeat(5, 1fr); grid-template-rows: repeat(5, 1fr);
        }
        .dot-btn { pointer-events: auto; display: flex; justify-content: center; align-items: center; }
        .dot-circle { width: 14px; height: 14px; border-radius: 50%; background: rgba(255,0,0,0.5); border: 2px solid white; }
        .dot-btn.active .dot-circle { background: #00ff00; transform: scale(1.2); }

        /* Marcadores */
        .marker {
            position: absolute; width: 24px; height: 24px; 
            transform: translate(-50%, -50%);
            border: 2px solid white; border-radius: 50%;
            z-index: 5; background: rgba(0,0,0,0.4);
            font-size: 14px; display: flex; justify-content: center; align-items: center; color: white; font-weight: bold;
        }
        #markers-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }

        /* UI */
        #ui-layer {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: rgba(20, 20, 20, 0.98); padding: 10px; box-sizing: border-box;
            border-top: 1px solid #333; z-index: 20; padding-bottom: 20px;
            display: flex; flex-direction: column; gap: 8px;
        }

        button {
            padding: 14px; border: none; border-radius: 6px;
            font-weight: bold; font-size: 1rem; text-transform: uppercase; cursor: pointer;
            width: 100%; outline: none; color: white;
        }
        .btn-measure { background: #FF9800; }
        .btn-fe { background: #9C27B0; }
        .btn-mark { background: #D32F2F; height: 60px; font-size: 1.2rem; border: 2px solid white; }
        .btn-save { background: #2E7D32; font-size: 1.1rem; }
        .btn-sec { background: #444; font-size: 0.9rem; padding: 10px; }

        .row { display: flex; gap: 8px; }
        input { padding: 8px; width: 100%; text-align: center; border-radius: 5px; border: none; background: #333; color: white; font-size: 1rem; }
        
        #result-panel {
            background: #222; padding: 8px; border-radius: 6px;
            display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 4px; text-align: center; font-size: 0.9rem;
        }
        .res-val { color: #fff; font-weight: bold; font-size: 1rem; display: block; }
        .big-val { color: #FFD700; font-size: 1.1rem; }

        /* Erro C√¢mera */
        #cam-error {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; display: none; z-index: 5;
        }
    </style>
</head>
<body>

    <div id="viewport">
        <div id="image-layer">
            <img id="photo-display">
            <div id="markers-container"></div>
            <video id="video-feed" autoplay playsinline muted></video>
        </div>
        
        <div id="crosshair-layer" style="display:none;"><div class="crosshair"></div></div>

        <div id="grid-layer">
            <div class="grid-box" id="dots-container"></div>
        </div>

        <div id="cam-error">
            <p>C√¢mera n√£o iniciou.</p>
            <button onclick="startCamera()" style="background: #007bff; width: auto;">Tentar Novamente</button>
        </div>

        <div id="ui-layer">
            <div class="row">
                <div style="flex:1"><label style="font-size:0.7rem; color:#aaa;">Baliza (m)</label><input type="number" id="ref-size" value="2.00" step="0.1"></div>
                <div style="flex:1"><label style="font-size:0.7rem; color:#aaa;">Tora (m)</label><input type="number" id="wood-size" value="3.00" step="0.1"></div>
            </div>

            <div id="result-panel">
                <div><span class="res-val" id="disp-h">--</span><small>ALT</small></div>
                <div><span class="res-val" id="disp-l">--</span><small>COMP</small></div>
                <div><span class="res-val" id="disp-fe">--</span><small>FE</small></div>
                <div style="grid-column: span 3; border-top:1px solid #444; margin-top:5px; padding-top:5px; display:flex; justify-content:space-around;">
                    <span>St: <b id="vol-st" class="big-val">0.00</b></span>
                    <span>Sol: <b id="vol-sol" class="big-val" style="color:#00ff00">0.00</b></span>
                </div>
            </div>

            <div id="start-btns" style="display:flex; flex-direction:column; gap:8px;">
                <div class="row">
                    <button class="btn-measure" onclick="initMode('HEIGHT')">üìè Altura</button>
                    <button class="btn-measure" style="background:#1565C0" onclick="initMode('LENGTH')">üìè Comprimento</button>
                </div>
                <button class="btn-fe" onclick="initMode('FE')">üì∏ Amostra Fe</button>
            </div>

            <button id="btn-save" class="btn-save" style="display:none;" onclick="savePile()">üíæ SALVAR PILHA</button>

            <div id="active-controls" class="row" style="display:none;">
                <button class="btn-sec" onclick="cancelMode()" style="width:60px;">‚ùå</button>
                <button id="btn-action" class="btn-mark" onclick="handleAction()">üéØ MARCAR</button>
            </div>
            
            <div class="row" style="margin-top:5px;">
                <button class="btn-sec" onclick="exportExcel()">üìÇ Excel (<span id="count">0</span>)</button>
                <button class="btn-sec" style="background:#333;" onclick="clearData()">üóëÔ∏è Limpar</button>
            </div>
        </div>
    </div>

    <script>
        // Setup
        const video = document.getElementById('video-feed');
        const imgDisplay = document.getElementById('photo-display');
        const imgLayer = document.getElementById('image-layer');
        const markersContainer = document.getElementById('markers-container');
        const dotsContainer = document.getElementById('dots-container');
        
        // UI
        const startBtns = document.getElementById('start-btns');
        const activeControls = document.getElementById('active-controls');
        const btnSave = document.getElementById('btn-save');
        const btnAction = document.getElementById('btn-action');
        const crosshair = document.getElementById('crosshair-layer');
        const gridLayer = document.getElementById('grid-layer');

        // State
        let mode = null; // 'HEIGHT', 'LENGTH', 'FE'
        let currentPile = { h:0, l:0, fe:[] };
        let points = [];
        let pxPerMeter = 1;
        let transform = { x:0, y:0, scale:1 };
        let lastTouch = { dist:0, x:0, y:0 };
        let isDragging = false;
        
        let dataStore = JSON.parse(localStorage.getItem('pinusV9')) || [];
        document.getElementById('count').innerText = dataStore.length;

        // --- C√¢mera Robusta ---
        async function startCamera() {
            document.getElementById('cam-error').style.display = 'none';
            try {
                // Tenta for√ßar a c√¢mera traseira ('environment')
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: { exact: "environment" } } 
                }).catch(() => {
                    // Se falhar (alguns celulares n√£o aceitam 'exact'), tenta modo suave
                    return navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                });
                
                video.srcObject = stream;
                // Espera o v√≠deo estar pronto
                video.onloadedmetadata = () => {
                    video.play();
                };
            } catch(e) {
                console.error("Erro Cam:", e);
                document.getElementById('cam-error').style.display = 'block';
                alert("N√£o foi poss√≠vel iniciar a c√¢mera. Verifique as permiss√µes do navegador.");
            }
        }
        startCamera(); // Inicia ao abrir
        createGrid();

        function createGrid() {
            dotsContainer.innerHTML = '';
            for(let i=0; i<25; i++) {
                const b = document.createElement('div');
                b.className = 'dot-btn';
                b.onclick = function() { this.classList.toggle('active'); };
                b.innerHTML = '<div class="dot-circle"></div>';
                dotsContainer.appendChild(b);
            }
        }

        // --- Fluxo ---
        function initMode(m) {
            mode = m;
            takePhoto(); // Captura e congela
            
            startBtns.style.display = 'none';
            btnSave.style.display = 'none';
            activeControls.style.display = 'flex';

            if (mode === 'FE') {
                gridLayer.style.display = 'flex';
                btnAction.innerText = "‚úÖ CONFIRMAR FE";
                btnAction.style.background = "#2E7D32";
                document.querySelectorAll('.dot-btn').forEach(d => d.classList.remove('active'));
            } else {
                crosshair.style.display = 'flex';
                btnAction.innerText = "üéØ MARCAR";
                btnAction.style.background = "#D32F2F";
            }
        }

        function takePhoto() {
            // Desenha v√≠deo no canvas invisivel -> joga na IMG
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            imgDisplay.src = canvas.toDataURL('image/jpeg');
            imgDisplay.style.display = 'block';
            video.style.display = 'none';
            
            // Reseta zoom
            transform = { x:0, y:0, scale:1 };
            imgLayer.style.transform = `translate(0px, 0px) scale(1)`;
            points = [];
            markersContainer.innerHTML = '';
        }

        function handleAction() {
            if (mode === 'FE') confirmFe();
            else markPoint();
        }

        function markPoint() {
            // Calcula posi√ß√£o relativa ao zoom
            const vw = window.innerWidth;
            const vh = window.innerHeight;
            const imgX = ((vw/2) - transform.x) / transform.scale;
            const imgY = ((vh/2) - transform.y) / transform.scale;

            points.push({x:imgX, y:imgY});
            
            // Renderiza marcador
            const mk = document.createElement('div');
            mk.className = 'marker';
            mk.style.left = imgX + 'px'; mk.style.top = imgY + 'px';
            mk.innerText = points.length;
            mk.style.borderColor = (points.length <= 2) ? 'red' : '#00ff00';
            markersContainer.appendChild(mk);

            // L√≥gica
            if (points.length === 2) {
                const dist = Math.hypot(points[1].x - points[0].x, points[1].y - points[0].y);
                pxPerMeter = dist / parseFloat(document.getElementById('ref-size').value);
            }
            if (points.length === 4) {
                const dist = Math.hypot(points[3].x - points[2].x, points[3].y - points[2].y);
                const val = dist / pxPerMeter;
                
                if (mode === 'HEIGHT') {
                    currentPile.h = val;
                    document.getElementById('disp-h').innerText = val.toFixed(2);
                } else {
                    currentPile.l = val;
                    document.getElementById('disp-l').innerText = val.toFixed(2);
                }
                finishAction();
            }
        }

        function confirmFe() {
            const active = document.querySelectorAll('.dot-btn.active').length;
            const feVal = active / 25;
            currentPile.fe.push(feVal);
            
            // M√©dia atual
            const avg = currentPile.fe.reduce((a,b)=>a+b,0) / currentPile.fe.length;
            document.getElementById('disp-fe').innerText = avg.toFixed(2);
            finishAction();
        }

        function finishAction() {
            calcTotals();
            cancelMode(); // Volta pra c√¢mera
        }

        function cancelMode() {
            imgDisplay.style.display = 'none';
            video.style.display = 'block';
            crosshair.style.display = 'none';
            gridLayer.style.display = 'none';
            activeControls.style.display = 'none';
            startBtns.style.display = 'flex'; // Volta menu
            
            // Verifica se pode salvar
            if (parseFloat(document.getElementById('vol-st').innerText) > 0) {
                btnSave.style.display = 'block';
            }
            
            // Tenta dar play na c√¢mera se ela pausou
            video.play().catch(e => console.log("Play error", e));
        }

        function calcTotals() {
            const w = parseFloat(document.getElementById('wood-size').value);
            const st = (currentPile.h > 0 && currentPile.l > 0) ? (currentPile.h * currentPile.l * w) : 0;
            
            let feAvg = 0;
            if (currentPile.fe.length > 0) feAvg = currentPile.fe.reduce((a,b)=>a+b,0) / currentPile.fe.length;
            
            const sol = st * (feAvg || 0);
            
            document.getElementById('vol-st').innerText = st.toFixed(2);
            document.getElementById('vol-sol').innerText = sol.toFixed(2);
        }

        function savePile() {
            dataStore.push({
                id: Date.now(),
                date: new Date().toLocaleString(),
                h: document.getElementById('disp-h').innerText,
                l: document.getElementById('disp-l').innerText,
                fe: document.getElementById('disp-fe').innerText,
                st: document.getElementById('vol-st').innerText,
                sol: document.getElementById('vol-sol').innerText
            });
            localStorage.setItem('pinusV9', JSON.stringify(dataStore));
            document.getElementById('count').innerText = dataStore.length;
            
            // Limpa
            currentPile = { h:0, l:0, fe:[] };
            document.getElementById('disp-h').innerText = "--";
            document.getElementById('disp-l').innerText = "--";
            document.getElementById('disp-fe').innerText = "--";
            calcTotals();
            btnSave.style.display = 'none';
            alert("Salvo!");
        }

        function clearData() {
            if(confirm("Apagar tudo?")) {
                dataStore = [];
                localStorage.setItem('pinusV9', '[]');
                document.getElementById('count').innerText = 0;
            }
        }

        function exportExcel() {
            if(!dataStore.length) return alert("Vazio");
            const ws = XLSX.utils.json_to_sheet(dataStore);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Dados");
            XLSX.writeFile(wb, "Inventario_Pinus.xlsx");
        }

        // --- Zoom Engine ---
        const view = document.getElementById('viewport');
        view.addEventListener('touchstart', e => {
            if(imgDisplay.style.display==='none') return;
            isDragging = true;
            if(e.touches.length === 2) lastTouch.dist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
            else { lastTouch.x = e.touches[0].clientX; lastTouch.y = e.touches[0].clientY; }
        });
        view.addEventListener('touchmove', e => {
            if(!isDragging) return;
            e.preventDefault();
            if(e.touches.length === 2) {
                const newDist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
                transform.scale = Math.max(0.5, Math.min(transform.scale * (newDist / lastTouch.dist), 8));
                lastTouch.dist = newDist;
            } else {
                transform.x += e.touches[0].clientX - lastTouch.x;
                transform.y += e.touches[0].clientY - lastTouch.y;
                lastTouch.x = e.touches[0].clientX;
                lastTouch.y = e.touches[0].clientY;
            }
            imgLayer.style.transform = `translate(${transform.x}px, ${transform.y}px) scale(${transform.scale})`;
        });
        view.addEventListener('touchend', () => isDragging = false);
    </script>
</body>
</html>