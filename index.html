<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PinusSniper V4 (Stable)</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <style>
        body { margin: 0; background: #000; color: white; font-family: sans-serif; overflow: hidden; }
        
        /* O Mundo (Foto e C√¢mera) */
        #viewport { 
            position: relative; width: 100vw; height: 100vh; overflow: hidden; background: #000;
        }
        
        #image-layer { transform-origin: 0 0; will-change: transform; }
        
        /* Mira Est√°tica (Sniper) */
        #crosshair-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: flex; justify-content: center; align-items: center; z-index: 10;
        }
        .crosshair {
            width: 50px; height: 50px;
            border: 2px solid #00ff00; border-radius: 5px; /* Quadrada para melhor enquadramento */
            position: relative;
        }
        .crosshair::after {
            content: ''; position: absolute; top: 50%; left: 50%; width: 6px; height: 6px;
            background: red; transform: translate(-50%, -50%); border-radius: 50%;
        }

        /* Marcadores Visuais */
        .marker {
            position: absolute; width: 20px; height: 20px; 
            transform: translate(-50%, -50%);
            border: 2px solid white; border-radius: 50%;
            z-index: 5; background: rgba(0,0,0,0.3);
            font-size: 12px; display: flex; justify-content: center; align-items: center; color: white; font-weight: bold;
        }

        /* UI e Controles */
        #ui-layer {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: rgba(10, 10, 10, 0.9); padding: 15px; box-sizing: border-box;
            border-top: 1px solid #333; z-index: 20;
            display: flex; flex-direction: column; gap: 10px;
        }

        .top-info {
            position: absolute; top: 0; left: 0; width: 100%;
            padding: 15px; background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
            text-align: center; z-index: 20; text-shadow: 1px 1px 2px black;
        }
        
        /* Bot√µes Otimizados */
        button {
            padding: 16px; border: none; border-radius: 8px;
            font-weight: bold; font-size: 1.1rem; text-transform: uppercase; cursor: pointer;
            width: 100%; box-shadow: 0 2px 4px rgba(0,0,0,0.5);
            transition: transform 0.1s;
        }
        button:active { transform: scale(0.98); }
        
        .btn-camera { background: #FF9800; color: white; }
        .btn-mark { background: #D32F2F; color: white; font-size: 1.3rem; border: 2px solid white; height: 70px; }
        .btn-save-h { background: #2E7D32; color: white; } /* Altura */
        .btn-save-l { background: #1976D2; color: white; } /* Comprimento */
        .btn-undo { background: #555; color: white; width: 70px; }

        .row { display: flex; gap: 10px; }
        input { padding: 8px; width: 70px; text-align: center; border-radius: 5px; border: none; background: #333; color: white; font-size: 1rem; }

        /* Notifica√ß√£o Toast */
        #toast {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.85); color: #00ff00; padding: 20px 40px; border-radius: 10px;
            font-size: 1.5rem; display: none; z-index: 100; border: 2px solid #00ff00;
        }
    </style>
</head>
<body>

    <div id="toast">‚úÖ SALVO!</div>

    <div id="viewport">
        <div id="image-layer">
            <img id="photo-display" style="display:none;">
            <div id="markers-container"></div>
            <video id="video-feed" autoplay playsinline style="width: 100%; height: 100%; object-fit: contain;"></video>
        </div>

        <div id="crosshair-layer" style="display:none;">
            <div class="crosshair"></div>
        </div>

        <div class="top-info">
            <span id="status-text" style="font-size: 1.2rem; font-weight: bold;">üì∑ Modo C√¢mera</span>
            <div id="instruction-text" style="font-size: 0.9rem; color: #ddd; margin-top: 5px;">Aponte para a pilha</div>
        </div>

        <div id="ui-layer">
            
            <div class="row" style="justify-content: space-between; align-items: center; margin-bottom: 5px;">
                <div>
                    Ref Baliza: <input type="number" id="ref-size" value="2.00" step="0.1"> m
                </div>
                <div id="measure-result" style="font-size: 1.3rem; color: #00ff00; font-weight: bold;">0.00 m</div>
            </div>

            <div id="btn-container">
                <button class="btn-camera" onclick="takePhoto()">üì∏ Capturar Foto</button>
            </div>

            <div id="edit-controls" class="row" style="display:none;">
                <button class="btn-undo" onclick="undoPoint()">‚Ü©</button>
                <button class="btn-mark" onclick="markPoint()">üéØ MARCAR</button>
            </div>

            <div id="save-controls" class="row" style="display:none;">
                <button class="btn-save-h" onclick="saveSafe('Altura')">Salvar ALTURA</button>
                <button class="btn-save-l" onclick="saveSafe('Comprimento')">Salvar COMPRIM.</button>
            </div>
            
            <div id="retry-btn" style="display:none; margin-top:5px;">
                <button style="background:#555; padding: 10px; font-size: 0.9rem;" onclick="resetApp()">üóëÔ∏è Descartar e Reiniciar</button>
            </div>

            <div style="text-align:center; font-size:0.7rem; margin-top:10px; color:#666;">
                Registros: <span id="data-count">0</span> | <a href="#" onclick="exportExcel()" style="color:#aaa;">Exportar Excel</a>
            </div>
        </div>
    </div>

    <script>
        // --- Setup ---
        const video = document.getElementById('video-feed');
        const imgDisplay = document.getElementById('photo-display');
        const imgLayer = document.getElementById('image-layer');
        const crosshair = document.getElementById('crosshair-layer');
        const markersContainer = document.getElementById('markers-container');
        
        // UI Text
        const statusText = document.getElementById('status-text');
        const instrText = document.getElementById('instruction-text');
        const resultDisp = document.getElementById('measure-result');
        const toast = document.getElementById('toast');

        // UI Groups
        const btnContainer = document.getElementById('btn-container');
        const editControls = document.getElementById('edit-controls');
        const saveControls = document.getElementById('save-controls');
        const retryBtn = document.getElementById('retry-btn');

        // Logic Vars
        let state = 'CAMERA'; 
        let points = [];
        let pxPerMeter = 1;
        let transform = { x: 0, y: 0, scale: 1 };
        let lastTouch = { x: 0, y: 0, dist: 0 };
        let isDragging = false;
        
        let dataStore = [];
        try {
            dataStore = JSON.parse(localStorage.getItem('pinusDataV4')) || [];
        } catch(e) { console.log('Erro LocalStorage', e); }
        document.getElementById('data-count').innerText = dataStore.length;

        // --- Camera Engine (Robustness Fix) ---
        async function startCamera() {
            try {
                // Solicita c√¢mera traseira
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment', width: { ideal: 4096 } } 
                });
                video.srcObject = stream;
                // For√ßa o play para garantir que n√£o esteja pausado
                await video.play();
            } catch(e) {
                alert("Erro ao iniciar c√¢mera: " + e.message);
            }
        }
        startCamera(); // Inicia ao carregar

        // --- A√ß√£o 1: Capturar ---
        function takePhoto() {
            // Desenha o frame atual no canvas invis√≠vel e joga na tag IMG
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);
            
            imgDisplay.src = canvas.toDataURL('image/jpeg');
            imgDisplay.style.display = 'block';
            video.style.display = 'none'; // Esconde v√≠deo, economiza GPU
            
            // Muda estado para Marca√ß√£o
            state = 'MARKING';
            resetUIForMarking();
        }

        // --- A√ß√£o 2: Marcar (Sniper Logic) ---
        function markPoint() {
            // Calcula o ponto central da tela relativo √† imagem com zoom
            const viewportW = window.innerWidth;
            const viewportH = window.innerHeight;
            
            // Reverte a matriz de transforma√ß√£o
            const imgX = ((viewportW / 2) - transform.x) / transform.scale;
            const imgY = ((viewportH / 2) - transform.y) / transform.scale;

            points.push({ x: imgX, y: imgY });
            
            // Cria o marcador visual
            const m = document.createElement('div');
            m.className = 'marker';
            m.style.left = imgX + 'px';
            m.style.top = imgY + 'px';
            m.innerText = points.length;
            m.style.borderColor = (points.length <= 2) ? '#ff4444' : '#00ff00';
            markersContainer.appendChild(m);

            checkProgress();
        }

        function undoPoint() {
            if(points.length === 0) return resetApp();
            points.pop();
            if(markersContainer.lastChild) markersContainer.lastChild.remove();
            checkProgress();
        }

        function checkProgress() {
            // L√≥gica de feedback baseada no n√∫mero de pontos
            const len = points.length;
            
            if (len === 0) updateInfo("Marque PONTA 1 da Baliza", "Use dois dedos para zoom/arrastar");
            else if (len === 1) updateInfo("Marque PONTA 2 da Baliza", "Alinhe a mira e clique em MARCAR");
            else if (len === 2) {
                // Calculou Refer√™ncia
                const dist = Math.hypot(points[1].x - points[0].x, points[1].y - points[0].y);
                const refVal = parseFloat(document.getElementById('ref-size').value);
                pxPerMeter = dist / refVal;
                updateInfo("Marque IN√çCIO da Pilha", "Refer√™ncia calibrada!");
            }
            else if (len === 3) updateInfo("Marque FIM da Pilha", "Quase l√°...");
            else if (len === 4) {
                // Calculou Medida Final
                const dist = Math.hypot(points[3].x - points[2].x, points[3].y - points[2].y);
                const finalVal = dist / pxPerMeter;
                resultDisp.innerText = finalVal.toFixed(2) + " m";
                
                // Vai para tela de Salvar
                state = 'SAVING';
                crosshair.style.display = 'none';
                editControls.style.display = 'none';
                saveControls.style.display = 'flex';
                retryBtn.style.display = 'block'; // Permite descartar
                updateInfo("Medida Pronta!", "Selecione o tipo para salvar");
            }
        }

        // --- A√ß√£o 3: Salvar Seguro (Anti-Crash) ---
        function saveSafe(tipo) {
            try {
                const val = resultDisp.innerText;
                const ref = document.getElementById('ref-size').value;
                
                // Salva no Array
                dataStore.push({
                    id: dataStore.length + 1,
                    data: new Date().toLocaleString(),
                    tipo: tipo,
                    valor: val,
                    ref: ref + 'm'
                });
                
                // Persiste no LocalStorage
                localStorage.setItem('pinusDataV4', JSON.stringify(dataStore));
                document.getElementById('data-count').innerText = dataStore.length;
                
                // Feedback Visual (Toast)
                showToast();

                // Pequeno delay para usu√°rio ver que salvou, depois reseta
                setTimeout(() => {
                    resetApp();
                }, 800);

            } catch(e) {
                alert("Erro ao salvar: " + e.message);
                resetApp(); // Tenta resetar mesmo com erro
            }
        }

        function showToast() {
            toast.style.display = 'block';
            setTimeout(() => { toast.style.display = 'none'; }, 1500);
        }

        function resetApp() {
            // Limpa Vari√°veis
            state = 'CAMERA';
            points = [];
            transform = { x: 0, y: 0, scale: 1 };
            
            // Limpa DOM
            markersContainer.innerHTML = '';
            imgDisplay.style.display = 'none';
            resultDisp.innerText = "0.00 m";
            
            // Restaura UI
            btnContainer.style.display = 'block';
            editControls.style.display = 'none';
            saveControls.style.display = 'none';
            crosshair.style.display = 'none';
            retryBtn.style.display = 'none';
            updateInfo("üì∑ Modo C√¢mera", "Aponte para a pilha");
            updateTransform();

            // REATIVA C√ÇMERA (Crucial para n√£o travar)
            video.style.display = 'block';
            video.play().catch(e => console.log("Video play request interrupted", e));
        }

        // --- Helpers de UI ---
        function updateInfo(main, sub) {
            statusText.innerText = main;
            instrText.innerText = sub;
        }

        function resetUIForMarking() {
            btnContainer.style.display = 'none';
            editControls.style.display = 'flex';
            crosshair.style.display = 'flex';
            updateInfo("Marque PONTA 1 da Baliza", "Use dois dedos para ampliar");
        }

        // --- Engine de Zoom/Pan (Touch) ---
        const view = document.getElementById('viewport');
        
        view.addEventListener('touchstart', e => {
            if(state !== 'MARKING') return;
            isDragging = true;
            if(e.touches.length === 2) lastTouch.dist = getDist(e.touches);
            else { lastTouch.x = e.touches[0].clientX; lastTouch.y = e.touches[0].clientY; }
        });

        view.addEventListener('touchmove', e => {
            if(state !== 'MARKING' || !isDragging) return;
            e.preventDefault();

            if(e.touches.length === 2) {
                // Zoom
                const newDist = getDist(e.touches);
                const delta = newDist / lastTouch.dist;
                transform.scale = Math.max(0.5, Math.min(transform.scale * delta, 8)); // Limite zoom 8x
                lastTouch.dist = newDist;
            } else {
                // Pan
                const dx = e.touches[0].clientX - lastTouch.x;
                const dy = e.touches[0].clientY - lastTouch.y;
                transform.x += dx;
                transform.y += dy;
                lastTouch.x = e.touches[0].clientX;
                lastTouch.y = e.touches[0].clientY;
            }
            updateTransform();
        });

        view.addEventListener('touchend', () => isDragging = false);

        function getDist(touches) {
            return Math.hypot(touches[0].clientX - touches[1].clientX, touches[0].clientY - touches[1].clientY);
        }

        function updateTransform() {
            imgLayer.style.transform = `translate(${transform.x}px, ${transform.y}px) scale(${transform.scale})`;
        }

        // --- Exporta√ß√£o ---
        function exportExcel() {
            if(dataStore.length === 0) return alert("Sem dados!");
            const ws = XLSX.utils.json_to_sheet(dataStore);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Inventario");
            XLSX.writeFile(wb, "Levantamento_V4.xlsx");
        }
    </script>
</body>
</html>