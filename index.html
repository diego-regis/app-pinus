<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PinusSniper V3</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <style>
        body { margin: 0; background: #000; color: white; font-family: sans-serif; overflow: hidden; }
        
        /* Container da Imagem (O Mundo) */
        #viewport { 
            position: relative; width: 100vw; height: 100vh; overflow: hidden; background: #111;
        }
        
        /* A Camada da Foto que ser√° movida/ampliada */
        #image-layer {
            transform-origin: 0 0;
            will-change: transform;
        }
        
        /* A Mira Fixa (Overlay) */
        #crosshair-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; /* Deixa o toque passar para a foto */
            display: flex; justify-content: center; align-items: center;
            z-index: 10;
        }
        .crosshair {
            width: 40px; height: 40px;
            border-left: 2px solid #00ff00; border-right: 2px solid #00ff00; /* Mira estilo Sniper */
            border-top: 2px solid #00ff00; border-bottom: 2px solid #00ff00;
        }
        .center-dot {
            width: 4px; height: 4px; background: red; border-radius: 50%;
            position: absolute; box-shadow: 0 0 4px white;
        }

        /* Marcadores na foto */
        .marker {
            position: absolute; width: 16px; height: 16px; 
            transform: translate(-50%, -50%);
            border: 2px solid white; border-radius: 50%;
            z-index: 5;
            font-size: 10px; display: flex; justify-content: center; align-items: center; color: white; font-weight: bold;
        }

        /* Interface de Controle */
        #ui-layer {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: rgba(0,0,0,0.8); padding: 15px; box-sizing: border-box;
            border-top: 2px solid #333; z-index: 20;
            display: flex; flex-direction: column; gap: 10px;
        }

        .top-info {
            position: absolute; top: 0; left: 0; width: 100%;
            padding: 10px; background: rgba(0,0,0,0.6); text-align: center;
            font-size: 1.1rem; z-index: 20;
        }
        
        button {
            padding: 18px; border: none; border-radius: 8px;
            font-weight: bold; font-size: 1.1rem; text-transform: uppercase; cursor: pointer;
            width: 100%; box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .btn-camera { background: #FF9800; color: white; }
        .btn-mark { background: #ff3d00; color: white; font-size: 1.3rem; border: 2px solid white; } /* Bot√£o de Disparo */
        .btn-save { background: #2E7D32; color: white; }
        .btn-undo { background: #555; color: white; width: 60px; }
        
        .row { display: flex; gap: 10px; }
        input { padding: 10px; width: 80px; text-align: center; border-radius: 5px; border: none; }

        #manual-input { display: none; background: #222; padding: 10px; border-radius: 8px; margin-top: 5px;}
    </style>
</head>
<body>

    <div id="viewport">
        <div id="image-layer">
            <img id="photo-display" style="display:none;">
            <div id="markers-container"></div>
            <video id="video-feed" autoplay playsinline style="width: 100%; height: 100%; object-fit: contain;"></video>
        </div>

        <div id="crosshair-layer" style="display:none;">
            <div class="crosshair"></div>
            <div class="center-dot"></div>
        </div>

        <div class="top-info">
            <span id="status-text">üì∑ Modo C√¢mera</span>
            <div style="font-size: 0.8rem; color: #ccc;" id="instruction-text">Aponte para a pilha</div>
        </div>

        <div id="ui-layer">
            
            <div class="row" style="justify-content: space-between; color: #aaa; font-size: 0.9rem;">
                <div style="display:flex; align-items:center; gap:5px;">
                    Ref: <input type="number" id="ref-size" value="2.00" step="0.1"> m
                </div>
                <div id="measure-result" style="font-size: 1.2rem; color: #00ff00; font-weight: bold;">0.00 m</div>
            </div>

            <div id="btn-container">
                <button id="main-btn" class="btn-camera" onclick="handleAction()">üì∏ Capturar Foto</button>
            </div>

            <div id="edit-controls" class="row" style="display:none;">
                <button class="btn-undo" onclick="undoPoint()">‚Ü©</button>
                <button class="btn-mark" onclick="markPoint()">üéØ MARCAR</button>
            </div>

            <div id="save-controls" class="row" style="display:none;">
                <button class="btn-save" onclick="saveData('Altura')">Salvar Altura</button>
                <button class="btn-save" style="background:#1976D2" onclick="toggleManualInput()">Comprimento...</button>
            </div>

            <div id="manual-input">
                <label>Modo Manual (Trena)</label>
                <div class="row">
                    <input type="number" id="manual-val" placeholder="0.00">
                    <button style="padding: 10px;" onclick="saveManual()">Salvar Manual</button>
                    <button style="padding: 10px; background:#444;" onclick="saveData('Comprimento')">Usar Foto</button>
                </div>
            </div>
            
            <div style="text-align:center; font-size:0.7rem; margin-top:5px; color:#555;">
                V3 PinusSniper - Dados: <span id="data-count">0</span>
                <br> <a href="#" onclick="exportExcel()" style="color:#777;">[Exportar Excel]</a>
            </div>
        </div>
    </div>

    <script>
        // --- Elementos ---
        const video = document.getElementById('video-feed');
        const imgDisplay = document.getElementById('photo-display');
        const imgLayer = document.getElementById('image-layer');
        const crosshair = document.getElementById('crosshair-layer');
        const markersContainer = document.getElementById('markers-container');
        
        const statusText = document.getElementById('status-text');
        const instructionText = document.getElementById('instruction-text');
        const measureRes = document.getElementById('measure-result');
        const mainBtn = document.getElementById('main-btn');
        const btnContainer = document.getElementById('btn-container');
        const editControls = document.getElementById('edit-controls');
        const saveControls = document.getElementById('save-controls');
        const manualInput = document.getElementById('manual-input');

        // --- Estado ---
        let state = 'CAMERA'; // CAMERA, MARKING, REVIEW
        let currentStep = 0; // 0:Ref1, 1:Ref2, 2:Med1, 3:Med2
        let points = [];
        let pxPerMeter = 0;
        let dataStore = JSON.parse(localStorage.getItem('pinusDataV3')) || [];
        document.getElementById('data-count').innerText = dataStore.length;

        // --- Vari√°veis de Zoom/Pan ---
        let transform = { x: 0, y: 0, scale: 1 };
        let lastTouch = { x: 0, y: 0, dist: 0 };
        let isDragging = false;

        // --- Inicializa√ß√£o ---
        async function initCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment', width: { ideal: 4096 } } 
                });
                video.srcObject = stream;
            } catch(e) { alert("Erro C√¢mera: " + e.message); }
        }
        initCamera();

        // --- L√≥gica Principal ---
        function handleAction() {
            if(state === 'CAMERA') {
                takePhoto();
            }
        }

        function takePhoto() {
            // Cria um canvas tempor√°rio para capturar o frame em alta resolu√ß√£o
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);
            
            // Converte para imagem e exibe
            imgDisplay.src = canvas.toDataURL('image/jpeg');
            imgDisplay.style.display = 'block';
            video.style.display = 'none'; // Esconde v√≠deo ao vivo
            
            // Prepara UI para marca√ß√£o
            state = 'MARKING';
            crosshair.style.display = 'flex'; // Mostra mira
            btnContainer.style.display = 'none';
            editControls.style.display = 'flex';
            
            // Reseta Transforma√ß√£o (Zoom)
            transform = { x: 0, y: 0, scale: 1 };
            updateTransform();
            
            updateStepInfo();
        }

        // --- Sistema de Marca√ß√£o "Sniper" ---
        function markPoint() {
            // O segredo: Calcular onde est√° o centro da tela RELATIVO √† imagem transformada
            const viewportW = window.innerWidth;
            const viewportH = window.innerHeight;
            
            // Ponto central da tela
            const screenX = viewportW / 2;
            const screenY = viewportH / 2;
            
            // Engenharia reversa da transforma√ß√£o CSS
            // imgX = (screenX - translation) / scale
            const imgX = (screenX - transform.x) / transform.scale;
            const imgY = (screenY - transform.y) / transform.scale;

            points.push({ x: imgX, y: imgY });
            
            // Desenhar marcador visual na imagem (que vai se mover junto com ela)
            const marker = document.createElement('div');
            marker.className = 'marker';
            marker.style.left = imgX + 'px';
            marker.style.top = imgY + 'px';
            marker.style.backgroundColor = (points.length <= 2) ? 'red' : '#00ff00';
            marker.innerHTML = points.length;
            markersContainer.appendChild(marker);

            // L√≥gica Florestal
            if (points.length === 2) {
                // Fim da refer√™ncia
                const dist = Math.hypot(points[1].x - points[0].x, points[1].y - points[0].y);
                const refVal = parseFloat(document.getElementById('ref-size').value);
                pxPerMeter = dist / refVal;
            } 
            else if (points.length === 4) {
                // Fim da medi√ß√£o
                const dist = Math.hypot(points[3].x - points[2].x, points[3].y - points[2].y);
                const finalVal = dist / pxPerMeter;
                
                measureRes.innerText = finalVal.toFixed(3) + " m";
                finishMeasurement();
            }

            currentStep++;
            updateStepInfo();
        }

        function undoPoint() {
            if(points.length > 0) {
                points.pop();
                currentStep--;
                markersContainer.lastChild.remove();
                updateStepInfo();
            } else {
                // Se desfazer o primeiro, volta pra c√¢mera
                resetApp();
            }
        }

        function finishMeasurement() {
            state = 'REVIEW';
            crosshair.style.display = 'none';
            editControls.style.display = 'none';
            saveControls.style.display = 'flex';
            statusText.innerText = "‚úÖ Medida Calculada";
            instructionText.innerText = "Salve como Altura ou Comprimento";
        }

        function updateStepInfo() {
            const steps = [
                "1. Mire na PONTA 1 da Baliza",
                "2. Mire na PONTA 2 da Baliza",
                "3. Mire no IN√çCIO da Pilha",
                "4. Mire no FIM da Pilha"
            ];
            statusText.innerText = steps[currentStep] || "Conclu√≠do";
            
            if(currentStep < 2) instructionText.innerText = "Calibrando Escala (Refer√™ncia)";
            else instructionText.innerText = "Medindo a Madeira";
        }

        // --- Controles de Toque (Pan & Zoom) ---
        const view = document.getElementById('viewport');
        
        view.addEventListener('touchstart', e => {
            if(state !== 'MARKING') return;
            isDragging = true;
            
            if(e.touches.length === 2) {
                lastTouch.dist = getDist(e.touches);
            } else {
                lastTouch.x = e.touches[0].clientX;
                lastTouch.y = e.touches[0].clientY;
            }
        });

        view.addEventListener('touchmove', e => {
            if(state !== 'MARKING' || !isDragging) return;
            e.preventDefault();

            if(e.touches.length === 2) {
                // ZOOM (Pinch)
                const newDist = getDist(e.touches);
                const delta = newDist / lastTouch.dist;
                
                const newScale = transform.scale * delta;
                if(newScale > 0.5 && newScale < 10) { // Limites de zoom
                    transform.scale = newScale;
                }
                lastTouch.dist = newDist;
            } else {
                // PAN (Arrastar)
                const dx = e.touches[0].clientX - lastTouch.x;
                const dy = e.touches[0].clientY - lastTouch.y;
                
                transform.x += dx;
                transform.y += dy;
                
                lastTouch.x = e.touches[0].clientX;
                lastTouch.y = e.touches[0].clientY;
            }
            updateTransform();
        });

        view.addEventListener('touchend', () => isDragging = false);

        function getDist(touches) {
            return Math.hypot(
                touches[0].clientX - touches[1].clientX,
                touches[0].clientY - touches[1].clientY
            );
        }

        function updateTransform() {
            imgLayer.style.transform = `translate(${transform.x}px, ${transform.y}px) scale(${transform.scale})`;
        }

        // --- Salvamento e Utilit√°rios ---
        function toggleManualInput() {
            saveControls.style.display = 'none';
            manualInput.style.display = 'block';
        }

        function saveManual() {
            const val = document.getElementById('manual-val').value;
            if(!val) return alert("Digite o valor");
            document.getElementById('measure-result').innerText = val + " m";
            saveData('Comprimento (Manual)');
        }

        function saveData(tipo) {
            const val = document.getElementById('measure-result').innerText;
            dataStore.push({
                id: dataStore.length + 1,
                data: new Date().toLocaleString(),
                tipo: tipo,
                valor: val,
                ref: document.getElementById('ref-size').value
            });
            localStorage.setItem('pinusDataV3', JSON.stringify(dataStore));
            document.getElementById('data-count').innerText = dataStore.length;
            
            // Reinicia
            resetApp();
        }

        function resetApp() {
            state = 'CAMERA';
            points = [];
            currentStep = 0;
            markersContainer.innerHTML = '';
            
            imgDisplay.style.display = 'none';
            video.style.display = 'block';
            
            btnContainer.style.display = 'block';
            crosshair.style.display = 'none';
            editControls.style.display = 'none';
            saveControls.style.display = 'none';
            manualInput.style.display = 'none';
            
            statusText.innerText = "üì∑ Modo C√¢mera";
            instructionText.innerText = "Aponte para a pilha";
            measureRes.innerText = "0.00 m";
            
            // Reseta zoom
            transform = { x: 0, y: 0, scale: 1 };
            updateTransform();
        }

        function exportExcel() {
            const ws = XLSX.utils.json_to_sheet(dataStore);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Dados");
            XLSX.writeFile(wb, "Levantamento_V3.xlsx");
        }
    </script>
</body>
</html>