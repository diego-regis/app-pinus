<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PinusSniper V12 (Precision)</title>
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üå≤</text></svg>">

    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <style>
        body { margin: 0; background: #000; color: white; font-family: sans-serif; overflow: hidden; user-select: none; }
        
        /* O "Palco" onde tudo acontece */
        #viewport { 
            position: relative; width: 100vw; height: 100vh; overflow: hidden; background: #222; 
        }
        
        /* C√¢mera (V√≠deo ao vivo) */
        #camera-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5;
            display: flex; align-items: center; justify-content: center;
        }
        video { 
            width: 100%; height: 100%; object-fit: cover; /* Cover garante tela cheia para mirar */
        }

        /* Camada M√≥vel (Foto + Marcadores) - Esta camada sofre o Zoom/Pan */
        #workspace-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            transform-origin: 0 0; will-change: transform; display: none; z-index: 6;
        }
        
        /* A Foto Congelada */
        #snapshot {
            display: block; position: absolute; left: 0; top: 0;
            /* A imagem define o tamanho do workspace */
            max-width: none; 
        }

        /* Mira (Fica parada no centro da tela) */
        #crosshair {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 40px; height: 40px; pointer-events: none; z-index: 50; display: none;
        }
        /* Desenho da Mira Precisa */
        #crosshair::before { content:''; position:absolute; left:50%; top:0; bottom:0; width:2px; background:#00ff00; transform:translateX(-50%); }
        #crosshair::after { content:''; position:absolute; top:50%; left:0; right:0; height:2px; background:#00ff00; transform:translateY(-50%); }
        #dot-center { position:absolute; top:50%; left:50%; width:4px; height:4px; background:red; transform:translate(-50%, -50%); border-radius:50%; z-index:51; }

        /* Marcadores (Bolinhas) */
        .marker {
            position: absolute; width: 20px; height: 20px; 
            transform: translate(-50%, -50%); /* Centraliza no ponto exato */
            border: 2px solid white; border-radius: 50%; 
            background: rgba(255, 0, 0, 0.5);
            font-size: 12px; display: flex; justify-content: center; align-items: center; font-weight: bold;
            box-shadow: 0 0 2px black;
        }
        .marker.green { background: rgba(0, 255, 0, 0.5); border-color: #fff; }

        /* UI (Bot√µes) */
        #ui-layer {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: rgba(10, 10, 10, 0.95); padding: 10px; box-sizing: border-box;
            border-top: 1px solid #333; z-index: 100; display: flex; flex-direction: column; gap: 10px;
            padding-bottom: 25px;
        }

        /* Bot√£o Reset Emerg√™ncia */
        #reset-cam-btn {
            position: absolute; top: 10px; right: 10px; z-index: 110;
            background: rgba(0,0,0,0.6); border: 1px solid #777; color: #ccc; padding: 5px 10px; border-radius: 20px; font-size: 0.7rem;
        }

        button {
            padding: 14px; border: none; border-radius: 8px; font-weight: bold; font-size: 1rem;
            text-transform: uppercase; cursor: pointer; color: white; width: 100%;
        }
        .btn-m { background: #FF9800; }
        .btn-act { background: #D32F2F; height: 60px; font-size: 1.2rem; border: 2px solid white; box-shadow: 0 4px 6px rgba(0,0,0,0.5); }
        .btn-save { background: #2E7D32; font-size: 1.1rem; margin-top: 5px; }
        .btn-small { background: #444; font-size: 0.85rem; padding: 10px; }

        .row { display: flex; gap: 10px; }
        input { padding: 10px; width: 100%; text-align: center; background: #333; color: white; border: none; border-radius: 5px; font-size: 1.1rem; }
        label { font-size: 0.75rem; color: #aaa; display: block; text-align: center; margin-bottom: 2px; }

        #stats {
            background: #222; padding: 10px; border-radius: 8px; display: grid;
            grid-template-columns: 1fr 1fr; gap: 10px; text-align: center;
        }
        .stat-box span { font-weight: bold; font-size: 1.2rem; color: #fff; }
        .total-row { grid-column: span 2; border-top: 1px solid #444; margin-top: 5px; padding-top: 8px; font-size: 1.4rem; color: #FFD700; font-weight: bold; }

        #toast {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9); border: 2px solid #00ff00; color: #00ff00;
            padding: 20px 40px; border-radius: 10px; display: none; z-index: 200; font-size: 1.5rem;
        }
    </style>
</head>
<body>

    <button id="reset-cam-btn" onclick="initCamera()">‚ôªÔ∏è Reset C√¢mera</button>
    <div id="toast">SALVO!</div>

    <div id="viewport">
        <div id="camera-layer">
            <video id="video" autoplay playsinline muted></video>
        </div>

        <div id="workspace-layer">
            <img id="snapshot">
            </div>

        <div id="crosshair">
            <div id="dot-center"></div>
        </div>

        <div id="ui-layer">
            
            <div style="text-align: center; font-size: 0.8rem; color: #777;">
                Pr√≥xima Pilha: <span id="next-id" style="color: #fff; font-weight: bold;">#1</span>
            </div>

            <div class="row">
                <div style="flex:1"><label>Baliza (m)</label><input type="number" id="inp-ref" value="2.00" step="0.1"></div>
                <div style="flex:1"><label>Tora (m)</label><input type="number" id="inp-wood" value="3.00" step="0.1"></div>
            </div>

            <div id="stats">
                <div class="stat-box"><span id="val-h">--</span><br><small style="color:#aaa">ALTURA</small></div>
                <div class="stat-box"><span id="val-l">--</span><br><small style="color:#aaa">COMPR.</small></div>
                <div class="total-row">
                    Vol: <span id="vol-total">0.00</span> st
                </div>
            </div>

            <div id="menu-main" style="display:flex; flex-direction:column; gap:10px;">
                <div class="row">
                    <button class="btn-m" onclick="startMode('HEIGHT')">üìè Altura</button>
                    <button class="btn-m" style="background:#1976D2" onclick="startMode('LENGTH')">üìè Comprimento</button>
                </div>
            </div>

            <button id="btn-save" class="btn-save" style="display:none;" onclick="savePile()">üíæ SALVAR PILHA</button>

            <div id="menu-action" class="row" style="display:none;">
                <button class="btn-small" onclick="cancelMode()" style="width:70px;">‚ùå</button>
                <button id="btn-fire" class="btn-act" onclick="addMarker()">üéØ MARCAR PONTO</button>
            </div>

            <div class="row" style="margin-top:5px;">
                <button class="btn-small" onclick="exportExcel()">üìÇ Excel (<span id="count">0</span>)</button>
                <button class="btn-small" style="background:#333;" onclick="clearData()">üóëÔ∏è Limpar</button>
            </div>
        </div>
    </div>

    <script>
        // --- UI Elements ---
        const video = document.getElementById('video');
        const workspace = document.getElementById('workspace-layer');
        const img = document.getElementById('snapshot');
        const crosshair = document.getElementById('crosshair');
        const menuMain = document.getElementById('menu-main');
        const menuAction = document.getElementById('menu-action');
        const btnSave = document.getElementById('btn-save');

        // --- Logic Variables ---
        let stream = null;
        let mode = null; 
        let points = [];
        let pxPerMeter = 1;
        let pile = { h:0, l:0 };
        
        // --- Transform State ---
        let transform = { x: 0, y: 0, scale: 1 };
        
        // --- Database ---
        let db = JSON.parse(localStorage.getItem('pinusV12')) || [];
        updateCounter();

        // --- 1. Camera System ---
        async function initCamera() {
            if (stream) stream.getTracks().forEach(t => t.stop());
            try {
                // Tenta FullHD
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment', width: { ideal: 1920 }, height: { ideal: 1080 } }
                });
                video.srcObject = stream;
                video.onloadedmetadata = () => video.play();
            } catch (e) {
                alert("Erro C√¢mera: " + e.message);
            }
        }
        initCamera();

        // --- 2. Capture Logic ---
        function startMode(m) {
            mode = m;
            
            // 1. Criar Canvas Tempor√°rio do tamanho exato da tela
            // Isso garante que o que voc√™ v√™ na tela √© exatamente o que √© capturado
            const canvas = document.createElement('canvas');
            const vw = window.innerWidth;
            const vh = window.innerHeight;
            canvas.width = vw;
            canvas.height = vh;
            const ctx = canvas.getContext('2d');

            // 2. Desenhar o v√≠deo preenchendo o canvas (simulando object-fit: cover)
            // Calculamos a propor√ß√£o para cortar as bordas extras do v√≠deo
            const vidW = video.videoWidth;
            const vidH = video.videoHeight;
            const screenRatio = vw / vh;
            const vidRatio = vidW / vidH;
            
            let drawW, drawH, startX, startY;

            if (vidRatio > screenRatio) {
                // V√≠deo mais largo que a tela (cortar laterais)
                drawH = vh;
                drawW = vh * vidRatio;
                startX = (vw - drawW) / 2;
                startY = 0;
            } else {
                // V√≠deo mais alto que a tela (cortar topo/base)
                drawW = vw;
                drawH = vw / vidRatio;
                startX = 0;
                startY = (vh - drawH) / 2;
            }

            ctx.drawImage(video, 0, 0, vidW, vidH, startX, startY, drawW, drawH);

            // 3. Jogar no IMG
            img.src = canvas.toDataURL('image/jpeg', 0.9);
            img.style.width = vw + 'px';
            img.style.height = vh + 'px';

            // 4. Resetar Workspace
            workspace.style.display = 'block';
            video.parentElement.style.display = 'none'; // Esconde camada v√≠deo
            
            // Reset Zoom
            transform = { x: 0, y: 0, scale: 1 };
            workspace.style.transform = `translate(0px, 0px) scale(1)`;
            
            // Limpar marcadores antigos
            document.querySelectorAll('.marker').forEach(el => el.remove());
            points = [];

            // UI Changes
            menuMain.style.display = 'none';
            btnSave.style.display = 'none';
            menuAction.style.display = 'flex';
            crosshair.style.display = 'block';
        }

        function cancelMode() {
            workspace.style.display = 'none';
            video.parentElement.style.display = 'flex'; // Mostra v√≠deo
            crosshair.style.display = 'none';
            menuAction.style.display = 'none';
            menuMain.style.display = 'flex';
            updateTotals();
            video.play().catch(()=>{});
        }

        // --- 3. Precision Marking Logic ---
        function addMarker() {
            // A M√°gica: Onde est√° a mira RELATIVO ao workspace transformado?
            
            // Centro da tela (Mira)
            const cx = window.innerWidth / 2;
            const cy = window.innerHeight / 2;

            // Converter para coordenadas dentro do Workspace
            // F√≥rmula: (Tela - Transla√ß√£o) / Escala
            const localX = (cx - transform.x) / transform.scale;
            const localY = (cy - transform.y) / transform.scale;

            points.push({ x: localX, y: localY });

            // Criar Marcador (Filho do Workspace, ent√£o se move com ele)
            const m = document.createElement('div');
            m.className = 'marker';
            if (points.length > 2) m.classList.add('green');
            m.innerText = points.length;
            
            // Posicionar
            m.style.left = localX + 'px';
            m.style.top = localY + 'px';
            
            workspace.appendChild(m);

            // C√°lculos
            if (points.length === 2) {
                // Baliza (1-2)
                const dist = Math.hypot(points[1].x - points[0].x, points[1].y - points[0].y);
                const ref = parseFloat(document.getElementById('inp-ref').value);
                pxPerMeter = dist / ref;
            }
            if (points.length === 4) {
                // Medida (3-4)
                const dist = Math.hypot(points[3].x - points[2].x, points[3].y - points[2].y);
                const val = dist / pxPerMeter;

                if (mode === 'HEIGHT') {
                    pile.h = val;
                    document.getElementById('val-h').innerText = val.toFixed(2);
                } else {
                    pile.l = val;
                    document.getElementById('val-l').innerText = val.toFixed(2);
                }
                cancelMode();
            }
        }

        // --- 4. Zoom & Pan Engine (Aplica no Workspace) ---
        let lastTouch = { dist: 0, x: 0, y: 0 };
        let isDragging = false;
        const inputArea = document.getElementById('viewport');

        inputArea.addEventListener('touchstart', e => {
            if (workspace.style.display === 'none') return;
            isDragging = true;
            if (e.touches.length === 2) {
                lastTouch.dist = Math.hypot(
                    e.touches[0].clientX - e.touches[1].clientX,
                    e.touches[0].clientY - e.touches[1].clientY
                );
            } else {
                lastTouch.x = e.touches[0].clientX;
                lastTouch.y = e.touches[0].clientY;
            }
        });

        inputArea.addEventListener('touchmove', e => {
            if (!isDragging) return;
            // Bloqueia scroll nativo
            if (e.target.tagName !== 'BUTTON' && e.target.tagName !== 'INPUT') e.preventDefault();

            if (e.touches.length === 2) {
                // PINCH ZOOM
                const newDist = Math.hypot(
                    e.touches[0].clientX - e.touches[1].clientX,
                    e.touches[0].clientY - e.touches[1].clientY
                );
                const factor = newDist / lastTouch.dist;
                
                // Limitar zoom entre 1x e 8x
                const newScale = transform.scale * factor;
                if (newScale >= 1 && newScale <= 8) {
                    // Zoom deve ser focado no centro? Simplificado para linear por enquanto
                    transform.scale = newScale;
                }
                lastTouch.dist = newDist;
            } else {
                // PAN (Arrastar)
                const dx = e.touches[0].clientX - lastTouch.x;
                const dy = e.touches[0].clientY - lastTouch.y;
                transform.x += dx;
                transform.y += dy;
                lastTouch.x = e.touches[0].clientX;
                lastTouch.y = e.touches[0].clientY;
            }
            applyTransform();
        });

        inputArea.addEventListener('touchend', () => isDragging = false);

        function applyTransform() {
            workspace.style.transform = `translate(${transform.x}px, ${transform.y}px) scale(${transform.scale})`;
        }

        // --- 5. Data & Export ---
        function updateTotals() {
            const w = parseFloat(document.getElementById('inp-wood').value);
            const st = (pile.h > 0 && pile.l > 0) ? (pile.h * pile.l * w) : 0;
            document.getElementById('vol-total').innerText = st.toFixed(2);
            btnSave.style.display = st > 0 ? 'block' : 'none';
        }

        function getNextId() {
            if (db.length === 0) return 1;
            const max = db.reduce((m, i) => Math.max(m, i.id), 0);
            return max + 1;
        }
        function updateCounter() {
            document.getElementById('count').innerText = db.length;
            document.getElementById('next-id').innerText = "#" + getNextId();
        }

        function savePile() {
            try {
                const nextId = getNextId();
                const st = document.getElementById('vol-total').innerText;
                
                db.push({
                    id: nextId,
                    date: new Date().toLocaleTimeString(),
                    h: pile.h.toFixed(2),
                    l: pile.l.toFixed(2),
                    w: document.getElementById('inp-wood').value,
                    st: st
                });
                localStorage.setItem('pinusV12', JSON.stringify(db));
                updateCounter();

                // Reset
                pile = { h:0, l:0 };
                document.getElementById('val-h').innerText = "--";
                document.getElementById('val-l').innerText = "--";
                updateTotals();

                const t = document.getElementById('toast');
                t.style.display = 'block';
                setTimeout(()=>t.style.display='none', 1500);
            } catch(e) { alert("Erro Salvar: " + e.message); }
        }

        function clearData() {
            if(confirm("Apagar tudo?")) {
                db=[]; localStorage.setItem('pinusV12', '[]'); updateCounter();
            }
        }

        function exportExcel() {
            if(!db.length) return alert("Vazio");
            const ws = XLSX.utils.json_to_sheet(db);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Inventario");
            XLSX.writeFile(wb, "Inventario_Pinus.xlsx");
        }
    </script>
</body>
</html>