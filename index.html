<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PinusSniper V13</title>
    
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üå≤</text></svg>">

    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <style>
        body { margin: 0; background: #000; color: white; font-family: sans-serif; overflow: hidden; user-select: none; }
        
        #viewport { position: relative; width: 100vw; height: 100vh; overflow: hidden; background: #000; }
        
        /* C√¢mera */
        #camera-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        video { width: 100%; height: 100%; object-fit: cover; } /* Cover preenche tudo */

        /* Workspace (Foto Congelada + Marcadores) */
        #workspace { 
            position: absolute; top: 0; left: 0; width: 100vw; height: 100vh; 
            transform-origin: 0 0; z-index: 2; display: none;
        }
        #snapshot { 
            width: 100%; height: 100%; display: block; 
        }

        /* Mira Sniper (Linhas de Tela Cheia para Precis√£o Absoluta) */
        #crosshair-h {
            position: absolute; top: 50%; left: 0; width: 100%; height: 1px; 
            background: rgba(0, 255, 0, 0.8); z-index: 50; pointer-events: none; display: none;
        }
        #crosshair-v {
            position: absolute; left: 50%; top: 0; height: 100%; width: 1px; 
            background: rgba(0, 255, 0, 0.8); z-index: 50; pointer-events: none; display: none;
        }
        /* Ponto central vermelho */
        #center-dot {
            position: absolute; top: 50%; left: 50%; width: 4px; height: 4px;
            background: red; border-radius: 50%; transform: translate(-50%, -50%);
            z-index: 51; pointer-events: none; display: none; box-shadow: 0 0 4px #000;
        }

        /* Marcadores (Cruzes fixas na imagem) */
        .marker {
            position: absolute; width: 0; height: 0;
            z-index: 5;
        }
        /* Desenho da cruz do marcador */
        .marker::before { content:''; position:absolute; left:-10px; top:0; width:20px; height:2px; background:red; box-shadow:0 0 2px black; }
        .marker::after { content:''; position:absolute; top:-10px; left:0; height:20px; width:2px; background:red; box-shadow:0 0 2px black; }
        .marker.green::before, .marker.green::after { background: #00ff00; }
        
        /* N√∫mero do marcador */
        .marker-label {
            position: absolute; top: -20px; left: 5px; 
            background: rgba(0,0,0,0.7); padding: 2px 5px; border-radius: 4px; font-size: 12px; font-weight: bold;
        }

        /* UI */
        #ui-layer {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: rgba(20, 20, 20, 0.98); padding: 10px; box-sizing: border-box;
            border-top: 1px solid #333; z-index: 100; display: flex; flex-direction: column; gap: 10px;
            padding-bottom: 25px;
        }

        button {
            padding: 14px; border: none; border-radius: 8px; font-weight: bold; font-size: 1rem;
            text-transform: uppercase; cursor: pointer; color: white; width: 100%;
        }
        .btn-m { background: #FF9800; }
        .btn-act { background: #D32F2F; height: 65px; font-size: 1.2rem; border: 2px solid white; box-shadow: 0 4px 6px rgba(0,0,0,0.5); }
        .btn-save { background: #2E7D32; font-size: 1.1rem; margin-top: 5px; box-shadow: 0 0 10px rgba(0,255,0,0.3); }
        .btn-small { background: #444; font-size: 0.85rem; padding: 10px; }

        .row { display: flex; gap: 10px; }
        input { padding: 10px; width: 100%; text-align: center; background: #333; color: white; border: none; border-radius: 5px; font-size: 1.1rem; }
        label { font-size: 0.75rem; color: #aaa; display: block; text-align: center; margin-bottom: 2px; }

        #stats {
            background: #222; padding: 10px; border-radius: 8px; display: grid;
            grid-template-columns: 1fr 1fr; gap: 10px; text-align: center;
        }
        .stat-box span { font-weight: bold; font-size: 1.2rem; color: #fff; }
        .total-row { grid-column: span 2; border-top: 1px solid #444; margin-top: 5px; padding-top: 8px; font-size: 1.4rem; color: #FFD700; font-weight: bold; }

        #toast {
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9); border: 2px solid #00ff00; color: #00ff00;
            padding: 20px 40px; border-radius: 10px; display: none; z-index: 200; font-size: 1.5rem;
        }

        #reset-cam-btn {
            position: absolute; top: 10px; right: 10px; z-index: 110;
            background: rgba(0,0,0,0.6); border: 1px solid #777; color: #ccc; padding: 5px 10px; border-radius: 20px; font-size: 0.7rem;
        }
    </style>
</head>
<body>

    <button id="reset-cam-btn" onclick="initCamera()">‚ôªÔ∏è Reset C√¢mera</button>
    <div id="toast">SALVO!</div>

    <div id="viewport">
        <div id="camera-layer"><video id="video" autoplay playsinline muted></video></div>

        <div id="workspace">
            <img id="snapshot">
            <div id="markers-container"></div>
        </div>

        <div id="crosshair-h"></div>
        <div id="crosshair-v"></div>
        <div id="center-dot"></div>

        <div id="ui-layer">
            <div style="text-align: center; font-size: 0.8rem; color: #777;">
                Pr√≥xima Pilha: <span id="next-id" style="color: #fff; font-weight: bold;">#1</span>
            </div>

            <div class="row">
                <div style="flex:1"><label>Baliza (m)</label><input type="number" id="inp-ref" value="2.00" step="0.1"></div>
                <div style="flex:1"><label>Tora (m)</label><input type="number" id="inp-wood" value="3.00" step="0.1"></div>
            </div>

            <div id="stats">
                <div class="stat-box"><span id="val-h">--</span><br><small style="color:#aaa">ALTURA</small></div>
                <div class="stat-box"><span id="val-l">--</span><br><small style="color:#aaa">COMPR.</small></div>
                <div class="total-row">Vol: <span id="vol-total">0.00</span> st</div>
            </div>

            <div id="menu-main" style="display:flex; flex-direction:column; gap:10px;">
                <div class="row">
                    <button class="btn-m" onclick="startMode('HEIGHT')">üìè Altura</button>
                    <button class="btn-m" style="background:#1976D2" onclick="startMode('LENGTH')">üìè Comprimento</button>
                </div>
            </div>

            <button id="btn-save" class="btn-save" style="display:none;" onclick="savePile()">üíæ SALVAR PILHA</button>

            <div id="menu-action" class="row" style="display:none;">
                <button class="btn-small" onclick="cancelMode()" style="width:70px;">‚ùå</button>
                <button id="btn-fire" class="btn-act" onclick="addMarker()">üéØ MARCAR</button>
            </div>

            <div class="row" style="margin-top:5px;">
                <button class="btn-small" onclick="exportExcel()">üìÇ Excel (<span id="count">0</span>)</button>
                <button class="btn-small" style="background:#333;" onclick="clearData()">üóëÔ∏è Limpar</button>
            </div>
        </div>
    </div>

    <script>
        // --- UI ---
        const video = document.getElementById('video');
        const workspace = document.getElementById('workspace');
        const img = document.getElementById('snapshot');
        const markersContainer = document.getElementById('markers-container');
        
        const crossH = document.getElementById('crosshair-h');
        const crossV = document.getElementById('crosshair-v');
        const centerDot = document.getElementById('center-dot');

        const menuMain = document.getElementById('menu-main');
        const menuAction = document.getElementById('menu-action');
        const btnSave = document.getElementById('btn-save');

        // --- Vari√°veis ---
        let stream = null;
        let mode = null;
        let points = [];
        let pxPerMeter = 1;
        let pile = { h:0, l:0 };
        
        // Transforma√ß√£o de Zoom
        let transform = { x: 0, y: 0, scale: 1 };

        let db = JSON.parse(localStorage.getItem('pinusV13')) || [];
        updateCounter();

        // --- 1. C√¢mera ---
        async function initCamera() {
            if(stream) stream.getTracks().forEach(t => t.stop());
            try {
                // Tenta FullHD para qualidade e estabilidade
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment', width: { ideal: 1920 }, height: { ideal: 1080 } }
                });
                video.srcObject = stream;
                video.onloadedmetadata = () => video.play();
            } catch(e) { alert("Erro C√¢mera: " + e.message); }
        }
        initCamera();

        // --- 2. Captura "Pixel Perfect" ---
        function startMode(m) {
            mode = m;
            
            // Cria um canvas exatamente do tamanho da TELA do celular
            // Isso elimina qualquer distor√ß√£o de aspect ratio
            const vw = window.innerWidth;
            const vh = window.innerHeight;
            
            const canvas = document.createElement('canvas');
            canvas.width = vw;
            canvas.height = vh;
            const ctx = canvas.getContext('2d');

            // Calcula como o v√≠deo (object-fit: cover) est√° sendo desenhado na tela
            // para desenhar IGUAL no canvas
            const vW = video.videoWidth;
            const vH = video.videoHeight;
            const screenRatio = vw / vh;
            const videoRatio = vW / vH;
            
            let sW, sH, sX, sY;

            if (videoRatio > screenRatio) {
                // V√≠deo mais largo que a tela (corta laterais)
                sH = vH;
                sW = vH * screenRatio;
                sX = (vW - sW) / 2;
                sY = 0;
            } else {
                // V√≠deo mais alto que a tela (corta topo/base)
                sW = vW;
                sH = vW / screenRatio;
                sX = 0;
                sY = (vH - sH) / 2;
            }

            // Desenha exatamente o recorte vis√≠vel
            ctx.drawImage(video, sX, sY, sW, sH, 0, 0, vw, vh);

            img.src = canvas.toDataURL('image/jpeg', 0.9);
            
            // Configura Workspace
            video.parentElement.style.display = 'none';
            workspace.style.display = 'block';
            
            // Reseta Zoom
            transform = { x:0, y:0, scale:1 };
            workspace.style.transform = `translate(0px, 0px) scale(1)`;
            
            markersContainer.innerHTML = '';
            points = [];

            // UI
            menuMain.style.display = 'none';
            btnSave.style.display = 'none';
            menuAction.style.display = 'flex';
            
            crossH.style.display = 'block';
            crossV.style.display = 'block';
            centerDot.style.display = 'block';
        }

        function cancelMode() {
            workspace.style.display = 'none';
            video.parentElement.style.display = 'block';
            
            crossH.style.display = 'none';
            crossV.style.display = 'none';
            centerDot.style.display = 'none';
            
            menuAction.style.display = 'none';
            menuMain.style.display = 'flex';
            
            updateTotals();
            video.play().catch(()=>{});
        }

        // --- 3. Marca√ß√£o de Precis√£o ---
        function addMarker() {
            // O centro da tela √© sempre o ponto de marca√ß√£o
            const screenCx = window.innerWidth / 2;
            const screenCy = window.innerHeight / 2;

            // Converter para coordenada interna do Workspace (considerando zoom/pan atual)
            const localX = (screenCx - transform.x) / transform.scale;
            const localY = (screenCy - transform.y) / transform.scale;

            points.push({ x: localX, y: localY });

            // Criar Marcador
            const m = document.createElement('div');
            m.className = 'marker ' + (points.length > 2 ? 'green' : '');
            m.style.left = localX + 'px';
            m.style.top = localY + 'px';
            
            const label = document.createElement('div');
            label.className = 'marker-label';
            label.innerText = points.length;
            m.appendChild(label);
            
            markersContainer.appendChild(m);

            // C√°lculos
            if (points.length === 2) {
                const dist = Math.hypot(points[1].x - points[0].x, points[1].y - points[0].y);
                const ref = parseFloat(document.getElementById('inp-ref').value);
                pxPerMeter = dist / ref;
            }
            if (points.length === 4) {
                const dist = Math.hypot(points[3].x - points[2].x, points[3].y - points[2].y);
                const val = dist / pxPerMeter;

                if (mode === 'HEIGHT') {
                    pile.h = val;
                    document.getElementById('val-h').innerText = val.toFixed(2);
                } else {
                    pile.l = val;
                    document.getElementById('val-l').innerText = val.toFixed(2);
                }
                cancelMode();
            }
        }

        // --- 4. Zoom Engine ---
        let lastTouch = { dist: 0, x: 0, y: 0 };
        let isDragging = false;
        const touchArea = document.getElementById('viewport');

        touchArea.addEventListener('touchstart', e => {
            if (workspace.style.display === 'none') return;
            isDragging = true;
            if (e.touches.length === 2) {
                lastTouch.dist = Math.hypot(
                    e.touches[0].clientX - e.touches[1].clientX, 
                    e.touches[0].clientY - e.touches[1].clientY
                );
            } else {
                lastTouch.x = e.touches[0].clientX;
                lastTouch.y = e.touches[0].clientY;
            }
        });

        touchArea.addEventListener('touchmove', e => {
            if (!isDragging) return;
            if (e.target.tagName !== 'BUTTON' && e.target.tagName !== 'INPUT') e.preventDefault();

            if (e.touches.length === 2) {
                const newDist = Math.hypot(
                    e.touches[0].clientX - e.touches[1].clientX, 
                    e.touches[0].clientY - e.touches[1].clientY
                );
                const factor = newDist / lastTouch.dist;
                const newScale = transform.scale * factor;
                
                if (newScale >= 1 && newScale <= 8) transform.scale = newScale;
                lastTouch.dist = newDist;
            } else {
                const dx = e.touches[0].clientX - lastTouch.x;
                const dy = e.touches[0].clientY - lastTouch.y;
                transform.x += dx;
                transform.y += dy;
                lastTouch.x = e.touches[0].clientX;
                lastTouch.y = e.touches[0].clientY;
            }
            workspace.style.transform = `translate(${transform.x}px, ${transform.y}px) scale(${transform.scale})`;
        });

        touchArea.addEventListener('touchend', () => isDragging = false);

        // --- 5. Dados ---
        function updateTotals() {
            const w = parseFloat(document.getElementById('inp-wood').value);
            const st = (pile.h > 0 && pile.l > 0) ? (pile.h * pile.l * w) : 0;
            document.getElementById('vol-total').innerText = st.toFixed(2);
            btnSave.style.display = st > 0 ? 'block' : 'none';
        }

        function getNextId() {
            if (!db.length) return 1;
            return db.reduce((m, i) => Math.max(m, i.id), 0) + 1;
        }
        function updateCounter() {
            document.getElementById('count').innerText = db.length;
            document.getElementById('next-id').innerText = "#" + getNextId();
        }

        function savePile() {
            try {
                db.push({
                    id: getNextId(),
                    date: new Date().toLocaleTimeString(),
                    h: pile.h.toFixed(2),
                    l: pile.l.toFixed(2),
                    w: document.getElementById('inp-wood').value,
                    st: document.getElementById('vol-total').innerText
                });
                localStorage.setItem('pinusV13', JSON.stringify(db));
                updateCounter();

                pile = { h:0, l:0 };
                document.getElementById('val-h').innerText = "--";
                document.getElementById('val-l').innerText = "--";
                updateTotals();

                const t = document.getElementById('toast');
                t.style.display = 'block';
                setTimeout(()=>t.style.display='none', 1500);
            } catch(e) { alert("Erro Salvar: " + e.message); }
        }

        function clearData() { if(confirm("Apagar tudo?")) { db=[]; localStorage.setItem('pinusV13', '[]'); updateCounter(); } }

        function exportExcel() {
            if(!db.length) return alert("Vazio");
            const ws = XLSX.utils.json_to_sheet(db);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Inventario");
            XLSX.writeFile(wb, "Inventario_Pinus.xlsx");
        }
    </script>
</body>
</html>